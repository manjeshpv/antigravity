<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Reports</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
        }

        a {
            display: inline-block;
            margin-bottom: 1rem;
            color: #007bff;
            text-decoration: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 2rem;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            width: 50%;
        }

        th:last-child {
            width: 20%;
        }

        td {
            text-align: right;
            font-weight: bold;
        }

        .total-row {
            background-color: #e8f5e9;
            font-size: 1.1em;
        }
    </style>
</head>

<body>
    <div class="container">
        <h3>Dashboard</h3>
        <div class="personal-details">
            <span>Name: Manjesh</span>|
            <span>Date of birth: 05 Feb 1989</span>
            <span>Age: <span id="age"></span></span>
        </div>

        <div class="strategy"
            style="background: #e3f2fd; padding: 1rem; margin-top: 1rem; border-radius: 8px; border-left: 5px solid #2196f3; text-align: left;">
            <h3 style="margin-top: 0; color: #1565c0;">Investment Strategy</h3>
            <ul style="margin-bottom: 0; padding-left: 20px; line-height: 1.6;">
                <li><strong>Initial Investment:</strong> Investing 2x amount in Arbitrage Fund (5% Return) via monthly
                    SIPs.</li>
                <li><strong>Secondary Investment:</strong> Investing 1x amount in Conservative Fund (10% Return) via
                    monthly SIPs.</li>
                <li><strong>Reinvestment Flow:</strong>
                    <ul>
                        <li>Payouts from Arbitrage Fund (Monthly) &rarr; Reinvested into Flexi Cap Fund (15% Return).
                        </li>
                        <li>Payouts from Conservative Fund (Annually on Oct 30) &rarr; Reinvested into Flexi Cap Fund
                            (15% Return).</li>
                    </ul>
                </li>
            </ul>
        </div>
        <h1>Summary Report</h1>

        <table id="reportTable">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Returns</th>
                    <th>XIRR</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th><a href="transactions.html?accountId=sbi">Invested Amount (Total SIPs)</a></th>
                    <td id="investedAmount">--</td>
                    <td></td>
                </tr>
                <tr>
                    <th><a href="transactions.html?accountId=pp5">Parag Parikh 5% Account (PP5)</a></th>
                    <td id="returns5" style="color: green;">--</td>
                    <td id="xirr5">--</td>
                </tr>
                <tr>
                    <th><a href="transactions.html?accountId=pp10">Returns from 10% Account (PP10)</a></th>
                    <td id="returns10" style="color: green;">--</td>
                    <td id="xirr10">--</td>
                </tr>
                <tr>
                    <th><a href="transactions.html?accountId=pp15">Returns from 15% Account (PP15)</a></th>
                    <td id="returns15" style="color: green;">--</td>
                    <td id="xirr15">--</td>
                </tr>
                <tr class="total-row">
                    <th><a href="breakup.html">Total Returns (by 30 Oct 2026)</a></th>
                    <td id="totalReturns2026">--</td>
                    <td id="xirrAggregate">--</td>
                </tr>
                <tr>
                    <th><a href="breakup.html">Further Returns (Oct 2026 - Mar 2027)</a></th>
                    <td id="furtherReturns">--</td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    </div>

    <script src="db.js"></script>
    <script>
        // Age Calculation (Existing)
        function calculateAge(dob) {
            const diff_ms = Date.now() - dob.getTime();
            const age_dt = new Date(diff_ms);
            return Math.abs(age_dt.getUTCFullYear() - 1970);
        }
        const dob = new Date('1989-02-05');
        document.getElementById('age').innerText = calculateAge(dob);
        document.addEventListener('DOMContentLoaded', () => {
            if (!window.db) {
                document.body.innerHTML = '<h1 style="text-align:center">Data not loaded. Run npm run generate.</h1>';
                return;
            }

            const { transactions } = window.db;

            // 1. Invested Amount: Description "SIP Investment" (or "SIP Credit" from enum, mapped to string in generate_data.js)
            // From generate_data.js: TransactionType.SIP_CREDIT = 'SIP Investment'
            const investedAmount = transactions
                .filter(tx => tx.description === 'SIP Investment')
                .reduce((sum, tx) => sum + tx.amount, 0);

            // 2. Returns 5% (PP5): "Interest Income" (Credit to pp5)
            const returns5 = transactions
                .filter(tx => tx.accountId === 'pp5' && tx.description === 'Interest Income' && tx.amount > 0)
                .reduce((sum, tx) => sum + tx.amount, 0);

            // 3. Returns 10% (PP10)
            const returns10 = transactions
                .filter(tx => tx.accountId === 'pp10' && tx.description === 'Interest Income' && tx.amount > 0)
                .reduce((sum, tx) => sum + tx.amount, 0);

            // 4. Returns 15% (PP15)
            const returns15 = transactions
                .filter(tx => tx.accountId === 'pp15' && tx.description === 'Interest Income' && tx.amount > 0)
                .reduce((sum, tx) => sum + tx.amount, 0);

            // 5. Total Returns (by 30 Oct 2026)
            const cutoffDate = new Date('2026-10-30');
            const totalReturns2026 = transactions
                .filter(tx =>
                    tx.description === 'Interest Income' &&
                    tx.amount > 0 &&
                    ['pp5', 'pp10', 'pp15'].includes(tx.accountId) &&
                    new Date(tx.date) <= cutoffDate
                )
                .reduce((sum, tx) => sum + tx.amount, 0);

            // 6. Further Returns (After 30 Oct 2026)
            const furtherReturns = transactions
                .filter(tx =>
                    tx.description === 'Interest Income' &&
                    tx.amount > 0 &&
                    ['pp5', 'pp10', 'pp15'].includes(tx.accountId) &&
                    new Date(tx.date) > cutoffDate
                )
                .reduce((sum, tx) => sum + tx.amount, 0);

            // Update DOM
            const format = (amt) => amt.toLocaleString('en-IN', { style: 'currency', currency: 'INR' });

            document.getElementById('investedAmount').innerText = format(investedAmount);
            document.getElementById('returns5').innerText = format(returns5);
            document.getElementById('returns10').innerText = format(returns10);
            document.getElementById('returns15').innerText = format(returns15);
            document.getElementById('totalReturns2026').innerText = format(totalReturns2026);
            document.getElementById('furtherReturns').innerText = format(furtherReturns);

            // --- XIRR Calculation Logic ---

            function calculateXIRR(cashFlows, guess = 0.1) {
                if (cashFlows.length === 0) return 0;

                const limit = 100; // Max iterations
                const tol = 1e-6; // Tolerance
                let xirr = guess;

                const startDate = new Date(cashFlows[0].date);

                for (let i = 0; i < limit; i++) {
                    let fValue = 0;
                    let fDerivative = 0;

                    for (const { date, amount } of cashFlows) {
                        const d = new Date(date);
                        const days = (d - startDate) / (1000 * 60 * 60 * 24);
                        const factor = Math.pow(1 + xirr, days / 365);

                        fValue += amount / factor;
                        fDerivative -= (amount * days) / (365 * factor * (1 + xirr));
                    }

                    if (Math.abs(fValue) < tol) {
                        return xirr;
                    }

                    if (Math.abs(fDerivative) < 1e-9) {
                        // Derivative too small, likely stuck
                        return xirr;
                    }

                    const newXirr = xirr - fValue / fDerivative;

                    if (!isFinite(newXirr)) return xirr; // Handle divergence

                    if (Math.abs(newXirr - xirr) < tol) {
                        return newXirr;
                    }
                    xirr = newXirr;
                }
                return xirr;
            }

            function getCashFlows(accountId, cutoffDate) {
                // 1. Filter Transactions for Cash Flow Stream (Investments/Payouts)
                const stream = transactions
                    .filter(tx =>
                        tx.accountId === accountId &&
                        new Date(tx.date) <= cutoffDate &&
                        ['SIP Investment', 'Reinvestment', 'Payout'].includes(tx.description) // Exclude Interest Income from Stream
                    ) // Assuming 'description' maps to those Enum values.
                    // Wait, in generate_data.js:
                    // SIP_CREDIT = 'SIP Investment'
                    // TransactionType.SIP_CREDIT is used.
                    // We need to match the STRING values stored in JSON.
                    // Let's check generate_data.js View again.
                    // generate_data.js imports enum, but stores the STRING value?
                    // addTransaction(..., TransactionType.SIP_CREDIT, ...)
                    // const TransactionType = { SIP_CREDIT: 'SIP Investment', ... }
                    // So we must match 'SIP Investment', 'Reinvestment', 'Payout'.
                    .filter(tx => {
                        const desc = tx.description;
                        return desc === 'SIP Investment' || desc === 'Reinvestment' || desc === 'Payout';
                    })
                    .map(tx => {
                        let cfAmount = 0;
                        if (tx.description === 'SIP Investment' || tx.description === 'Reinvestment') {
                            // Inflow to fund: Treated as NEGATIVE for XIRR (Investment)
                            // In DB: Amount is POSITIVE (Asset Increase).
                            cfAmount = -tx.amount;
                        } else if (tx.description === 'Payout') {
                            // Outflow from fund: Treated as POSITIVE for XIRR (Return)
                            // In DB: Amount is NEGATIVE (Asset Decrease).
                            cfAmount = -tx.amount; // - (-val) = +val
                        }
                        return { date: tx.date, amount: cfAmount };
                    });

                // 2. Calculate Terminal Value (Balance at Cutoff)
                const balance = transactions
                    .filter(tx => tx.accountId === accountId && new Date(tx.date) <= cutoffDate)
                    .reduce((sum, tx) => sum + tx.amount, 0);

                if (balance > 0) {
                    stream.push({ date: cutoffDate.toISOString().split('T')[0], amount: balance });
                }

                return stream.sort((a, b) => new Date(a.date) - new Date(b.date));
            }

            const xirrDate = new Date('2026-10-30'); // Same as Total Returns Cutoff

            // Calculate XIRR for each
            const cf5 = getCashFlows('pp5', xirrDate);
            const xirr5 = calculateXIRR(cf5);

            const cf10 = getCashFlows('pp10', xirrDate);
            const xirr10 = calculateXIRR(cf10);

            const cf15 = getCashFlows('pp15', xirrDate);
            const xirr15 = calculateXIRR(cf15);

            // Portfolio XIRR (Total)
            // Stream: External Inflows (SIPs to pp5/pp10) + Terminal Value (Sum of all balances)
            // We ignore internal flows (Payout pp5 -> Reinvest pp15) as they cancel out if we sum them? 
            // Better to construct explicitly:
            // Inflows: SIP Investment into pp5 OR pp10.
            // Terminal: Balance pp5 + Balance pp10 + Balance pp15.
            const portfolioStream = transactions
                .filter(tx =>
                    (tx.accountId === 'pp5' || tx.accountId === 'pp10') &&
                    tx.description === 'SIP Investment' &&
                    new Date(tx.date) <= xirrDate
                )
                .map(tx => ({ date: tx.date, amount: -tx.amount })); // Investment is negative

            const bal5 = transactions.filter(tx => tx.accountId === 'pp5' && new Date(tx.date) <= xirrDate).reduce((s, t) => s + t.amount, 0);
            const bal10 = transactions.filter(tx => tx.accountId === 'pp10' && new Date(tx.date) <= xirrDate).reduce((s, t) => s + t.amount, 0);
            const bal15 = transactions.filter(tx => tx.accountId === 'pp15' && new Date(tx.date) <= xirrDate).reduce((s, t) => s + t.amount, 0);

            const totalBalance = bal5 + bal10 + bal15;
            portfolioStream.push({ date: xirrDate.toISOString().split('T')[0], amount: totalBalance });

            const xirrTotal = calculateXIRR(portfolioStream.sort((a, b) => new Date(a.date) - new Date(b.date)));

            // Update UI
            const formatPct = (val) => (val * 100).toFixed(2) + '%';

            document.getElementById('xirr5').innerText = formatPct(xirr5);
            document.getElementById('xirr10').innerText = formatPct(xirr10);
            document.getElementById('xirr15').innerText = formatPct(xirr15);
            document.getElementById('xirrAggregate').innerText = formatPct(xirrTotal);
            // document.getElementById('xirrTotal').innerText = formatPct(xirrTotal);
        });
    </script>
</body>

</html>